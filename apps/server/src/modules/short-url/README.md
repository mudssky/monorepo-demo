
# 短链服务  

早期的短链服务常见于短信的场景,因为短信是按照字符收费的.使用短链减少字符的数量.  
用户可以通过短链跳转到原链接,相比较长的原链接,更便于分享.

## 短链跳转原理

数据库里存了短链到长链的映射.
访问短链服务时,从数据库中查找对应的长链接,然后重定向即可
有两种重定向

301 是永久重定向，就是重定向一次之后，下次浏览器就不会再访问短链，会直接访问长链接。

302 是临时重定向，下次访问短链依然会先访问短链服务，返回 302 后再重定向到长链。

301 的话，短链服务压力小，不过 302 每次都会先访问短链服务，这样可以记录链接的访问次数等数据。

## 生成短链的三种方案

短链一般只包含英文字符数字,所以最后一步适合用base62来编码
base62就是大小写英文字母(26*2)+10个数字组成的编码.
base64会多两个字符(+和/),还有=用于填充.

### 方案一 递增id  

递增id用base62编码,问题是很容易被猜出来,缺乏安全性  

### 方案二 对url做hash

直接用md5生成之类编码太长
可以采用生成之后,每4位取一位的方式,但是存在哈希碰撞的问题(即两个不同url的hash值相同)

### 方案三 随机字符串

6位长度,每个位都采用base62编码,有62种可能,则总共有`62^6`,即580亿种可能性.  
足够使用了.  

但是我们也要检查随机数重复的可能性,这个可以在生成后查表检查是否重复  

如果每次生成都查表,会出现性能不好的情况.所以可以用定时任务,提前生成一批压缩码,需要用的时候,直接取.  

```ts
import * as  base62 from "base62/lib/ascii";

export function generateRandomStr(len: number) {
    let str = '';
    for(let i = 0; i < len; i++) {
        const num = Math.floor(Math.random() * 62);
        str += base62.encode(num);
    }
    return str;
}
```
